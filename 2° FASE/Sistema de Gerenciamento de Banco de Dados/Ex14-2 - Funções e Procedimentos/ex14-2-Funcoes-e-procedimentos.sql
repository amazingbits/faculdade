/*UTILS*/
SET GLOBAL log_bin_trust_function_creators = 1;

/*SCRIPT*/
SET SQL_SAFE_UPDATES = 0;
DROP DATABASE IF EXISTS DBFOLHAPAGAMENTO;
CREATE DATABASE DBFOLHAPAGAMENTO;
USE DBFOLHAPAGAMENTO;

CREATE TABLE DEPARTAMENTO (
	IDDEPARTAMENTO INT NOT NULL PRIMARY KEY auto_increment,
	NOME VARCHAR(100)
);

INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(1, 'FINANCEIRO');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(2, 'COBRANÇA');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(3, 'CONTABILIDADE');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(4, 'AUDITORIA');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(5, 'LOGISTICA');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(6, 'PRODUÇÃO');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(7, 'OPERAÇÕES');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(8, 'RECURSOS HUMANOS');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(9, 'TI');
INSERT INTO DEPARTAMENTO (IDDEPARTAMENTO, NOME)VALUES(10, 'MARKETING');

CREATE TABLE FUNCAO (
	IDFUNCAO INT NOT NULL PRIMARY KEY auto_increment
	, NOME VARCHAR(100)
	, BONUS NUMERIC(9,2)
);

INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(1, 'ANALISTA ADMINISTRATIVO', 10);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(2, 'ANALISTA FINANCEIRO', 10);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(3, 'ANALISTA DE SISTEMAS', 10);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(4, 'ANALISTA DE RECURSOS HUMANOS', 10);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(5, 'ASSISTENTE DE MANUTENÇÃO', 8);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(6, 'ASSISTENTE ADMINISTRATIVO', 8);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(7, 'SECRETÁRIA', 3);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(8, 'AUXILIAR ADMINISTRATIVO', 4);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(9, 'AUXILIAR DE PRODUÇÃO', 4);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(10, 'OPERADOR', 2);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(11, 'ENCARREGADO', 2);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(12, 'PROGRAMADOR', 2);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(13, 'PUBLICITARIO', 2);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(14, 'DIAGRAMADOR', 2);
INSERT INTO FUNCAO (IDFUNCAO, NOME, BONUS)VALUES(15, 'JORNALISTA', 2);

CREATE TABLE FUNCIONARIO (
	IDFUNCIONARIO INT NOT NULL PRIMARY KEY auto_increment,
	IDDEPARTAMENTO INT,
	IDFUNCAO INT,
	NOME VARCHAR(100),
	SEXO CHAR(1),
	IDADE INT,
	DTADMISSAO DATETIME NOT NULL,
	DTDEMISSAO DATETIME,
	SALARIO_BASE NUMERIC(9,2),
	CONSTRAINT FK_FUNCIONARIO_DEPARTAMENTO FOREIGN KEY (IDDEPARTAMENTO) REFERENCES DEPARTAMENTO (IDDEPARTAMENTO),
	CONSTRAINT FK_FUNCIONARIO_FUNCAO FOREIGN KEY (IDFUNCAO) REFERENCES FUNCAO (IDFUNCAO) 
);

INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(1,  2, 'Robert Pers'		, 'M', 19, '2012-01-16 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(1,  8, 'Roberto Garcam'	, 'M', 25, '2011-08-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(1,  8, 'Guilherme Maril'	, 'M', 25, '2012-02-17 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(1,  7, 'Aline Cristina'	, 'F', 19, '2000-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(2,  1, 'Jerônimo DalaSi'	, 'M', 26, '2012-01-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(2,  6, 'Thiago Ciello'		, 'M', 29, '2011-11-17 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(2,  7, 'Aline Batista'		, 'F', 19, '2001-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(3,  NULL, 'Lucas Logrini'		, 'M', 28, '2012-07-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(3,  6, 'Lucas Mellva'		, 'M', 29, '2012-08-18 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(3,  7, 'Beatriz AlVinO'	, 'F', 22, '2004-10-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  1, 'Roberto Adez'		, 'M', 26, '2012-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  6, 'Pedro Siues'		, 'M', 19, '2011-01-28 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  6, 'Nathan Sendil'		, 'M', 25, '2012-10-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  7, 'Gabriela Cristina'	, 'F', 30, '2012-05-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(5,  1, 'Paulo Cerasa'		, 'M', 22, '2002-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(5,  NULL, 'Lucas Olivio'		, 'M', 28, '2012-12-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(5,  6, 'João Viwerz'		, 'M', 19, '2011-08-13 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(3,  7, 'Beatriz AlVinO'	, 'F', 22, '2004-10-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  1, 'Roberto Adez'		, 'M', 26, '2012-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  6, 'Pedro Siues'		, 'M', 19, '2011-01-28 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  6, 'Nathan Sendil'		, 'M', 25, '2012-10-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(4,  7, 'Gabriela Cristina'	, 'F', 30, '2012-05-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL,  1, 'Paulo Cerasa'		, 'M', 22, '2002-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL,  6, 'Lucas Olivio'		, 'M', 28, '2012-12-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL,  6, 'João Viwerz'		, 'M', 19, '2011-08-13 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL,  7, 'Gabrielle Alenade'	, 'F', 25, '2012-11-13 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(6,  5, 'Matheus kamp'		, 'M', 30, '2012-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(6,  9, 'Matheus Lorb'		, 'M', 26, '2001-04-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(6, 10, 'Rhuan Rorti'		, 'M', 28, '2012-02-13 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(6, 10, 'Paulo Heqt'		, 'M', 19, '2002-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(6,  7, 'Victoria Cuehler'	, 'F', 27, '2012-12-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL,  6, 'João Saebr'		, 'M', 30, '2002-08-14 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL, 11, 'Lucas Furil'		, 'M', 22, '2001-03-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL, 10, 'Rhamon Rool'		, 'M', 31, '2012-07-14 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(NULL, 10, 'Matheus Moricensk'	, 'M', 19, '2002-08-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(8,  4, 'Rodrigo Livier'	, 'M', 22, '2012-03-16 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(8,  NULL, 'Guilherme Freder'	, 'M', 26, '2001-09-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(8,  NULL, 'Ricardo Rodess'	, 'M', 19, '2012-08-22 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(9,  3, 'Gabriel Aller'		, 'M', 27, '2010-05-12 14:00:00', 0000.00);
INSERT INTO FUNCIONARIO (IDDEPARTAMENTO, IDFUNCAO, NOME, SEXO, IDADE, DTADMISSAO, SALARIO_BASE)VALUES(9, 12, 'Breno BeieRosa'	, 'M', 19, '2012-08-26 14:00:00', 0000.00);

UPDATE FUNCIONARIO SET SALARIO_BASE = RAND() * 1000 * 2;
UPDATE FUNCIONARIO SET SALARIO_BASE =  SALARIO_BASE * 20 WHERE SALARIO_BASE < 200;
UPDATE FUNCIONARIO SET SALARIO_BASE =  SALARIO_BASE * 10 WHERE SALARIO_BASE < 100;
UPDATE FUNCIONARIO SET SALARIO_BASE =  SALARIO_BASE * 4 WHERE SALARIO_BASE < 300;
UPDATE FUNCIONARIO SET SALARIO_BASE =  SALARIO_BASE * 2 WHERE SALARIO_BASE < 700;

CREATE TABLE FOLHA_PAGAMENTO (
	IDFOLHA INT NOT NULL AUTO_INCREMENT
	, IDFUNCIONARIO INT NOT NULL
	, ANO_REFERENCIA INT
	, MES_REFERENCIA INT
	, DT_GERACAO DATE
	, DT_PAGAMENTO DATE
	, VALOR_BASE NUMERIC(9,2)
	, AUXILIO_MEDICO NUMERIC(9,2)
	, AUXILIO_TRANSPORTE NUMERIC(9,2)
	, AUXILIO_ALIMENTACAO NUMERIC(9,2)
	, BONUS_FUNCAO NUMERIC(9,2)
	, PRIMARY KEY (IDFOLHA)
	, FOREIGN KEY (IDFUNCIONARIO) REFERENCES FUNCIONARIO (IDFUNCIONARIO)
);


/*FUNÇÕES*/
DELIMITER $$

CREATE FUNCTION FN_DIA_UTIL(MES INT, ANO INT) RETURNS DATE
BEGIN

DECLARE DT_UTIL DATE;
DECLARE COUNTER INT;

SET DT_UTIL = CONCAT(ANO, "-", MES, "-01");

CASE
	WHEN DAYOFWEEK(DT_UTIL) = 1 THEN SET DT_UTIL = ADDDATE(DT_UTIL, INTERVAL 5 DAY);
    WHEN DAYOFWEEK(DT_UTIL) = 2 THEN SET DT_UTIL = ADDDATE(DT_UTIL, INTERVAL 4 DAY);
    ELSE SET DT_UTIL = ADDDATE(DT_UTIL, INTERVAL 6 DAY);
END CASE;

RETURN DT_UTIL;

END $$

/*PROCEDURES*/
CREATE PROCEDURE PC_GERAR_PGTO(IN MES INT, IN ANO INT)
BEGIN

	-- CONTROLE DE MÊS 
    IF((MES BETWEEN 1 AND 12) IS FALSE) THEN
		SIGNAL SQLSTATE "45000" SET MESSAGE_TEXT = "MÊS INVÁLIDO";
    END IF;
    
    -- DELETANDO TODOS OS DADOS COM O MESMO MÊS E ANO
    DELETE FROM FOLHA_PAGAMENTO WHERE ANO_REFERENCIA = ANO AND MES_REFERENCIA = MES;
	
    -- INSERINDO DADOS DA FOLHA DE PAGAMENTO
    INSERT INTO FOLHA_PAGAMENTO (	IDFUNCIONARIO, 
									ANO_REFERENCIA, 
                                    MES_REFERENCIA, 
                                    DT_GERACAO, 
                                    DT_PAGAMENTO, 
                                    VALOR_BASE, 
                                    AUXILIO_MEDICO, 
                                    AUXILIO_TRANSPORTE, 
                                    AUXILIO_ALIMENTACAO, 
                                    BONUS_FUNCAO)
    SELECT 	FUNCIONARIO.IDFUNCIONARIO,
			ANO,
            MES,
            CONCAT(YEAR(NOW()), "-", MONTH(NOW()), "-", DAY(NOW())),
            FN_DIA_UTIL(MES, ANO),
			FUNCIONARIO.SALARIO_BASE AS SAL_BASE,
            250,
            150,
            650,
            IFNULL(FUNCIONARIO.SALARIO_BASE + (FUNCIONARIO.SALARIO_BASE * (FUNCAO.BONUS/100)),0.00) AS SALARIO_FINAL
    FROM FUNCIONARIO
    LEFT JOIN FUNCAO ON
    (FUNCIONARIO.IDFUNCAO = FUNCAO.IDFUNCAO);
    
END $$

DELIMITER ;

-- TESTAR A FUNÇÃO
-- SELECT FN_DIA_UTIL("07","2020");

-- TESTAR O PROCEDURE
 -- CALL PC_GERAR_PGTO(12,2020);

-- SELECT FINAL
/*
SELECT 	FUNCIONARIO.NOME AS FUNCIONARIO,
		IFNULL(FUNCAO.NOME,"SEM FUNÇÃO") AS FUNCAO,
		FOLHA_PAGAMENTO.* 
FROM FOLHA_PAGAMENTO
INNER JOIN FUNCIONARIO ON 
(FOLHA_PAGAMENTO.IDFUNCIONARIO = FUNCIONARIO.IDFUNCIONARIO)
LEFT JOIN FUNCAO ON 
(FUNCIONARIO.IDFUNCAO = FUNCAO.IDFUNCAO)
LEFT JOIN DEPARTAMENTO ON
(FUNCIONARIO.IDDEPARTAMENTO = DEPARTAMENTO.IDDEPARTAMENTO)
ORDER BY 	FOLHA_PAGAMENTO.ANO_REFERENCIA,
			FOLHA_PAGAMENTO.MES_REFERENCIA,
            DEPARTAMENTO.NOME,
            FUNCAO;
*/